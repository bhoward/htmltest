<!DOCTYPE html>
<html>
  <!-- Based on https://developers.google.com/youtube/iframe_api_reference -->
  <head>
    <title>Video Test</title>
    <link href="/htmltest/favicon.ico" rel="icon" type="image/x-icon" />
    <style type="text/css">
        iframe.third {
            aspect-ratio: 16/9;
            width: 33%;
            border: 0;
        }
        input#time {
            width: 80%;
        }
    </style>
    <script async type="text/javascript" src="https://www.youtube.com/iframe_api"></script>
    <script type="text/javascript">
      var players = [];
      var seqNo = 0;

      function onYouTubeIframeAPIReady() {
        addPlayer('bV-UUO7Um58');
        addPlayer('zQpWiGZ6EBk');
        addPlayer('ARaO-PUkPzQ');
        addPlayer('dPTuEesIzWM');
        addPlayer('0hZHp3faHzA');
        addPlayer('oq6nJka7hNc');
        addPlayer('z7VVmi78sSM');
        addPlayer('CwnlNQSHBfc');
        addPlayer('DRA2r1h70vw');
        addPlayer('WiEy2tXJrQQ');
        addPlayer('aWVfQ4xk_kU');
        addPlayer('TJquVALt81U');

        timeSelect.addEventListener('change', event =>
            seekAll(Number(event.target.value)), false);
        timeSelect.addEventListener('input', event =>
            timeLabel.innerHTML = '-' + secondsToHHMMSS(-event.target.value));
      }

      function addPlayer(videoId) {
        let id = 'player' + (++seqNo);
        let playerDiv = document.createElement('div');
        playerDiv.id = id;
        playerDiv.className = 'third';
        playersDiv.appendChild(playerDiv);
        players.push(createPlayer(id, videoId));
      }

      function createPlayer(id, videoId) {
        let player = new YT.Player(id, {
            videoId: videoId,
            playerVars: {
                'playsinline': 1,
                // 'controls': 0,
                // 'origin': 'bhoward.github.io',
            },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange,
            }
        });
        player.initialized = false;
        return player;
      }
      function onPlayerReady(event) {
        let player = event.target;
        player.playVideo();
        player.mute();
      }

      function onPlayerStateChange(event) {
        let player = event.target;
        if (event.data == YT.PlayerState.PLAYING && !player.initialized) {
          player.zeroTime = Date.now() / 1000 - player.getCurrentTime();
          player.initialized = true;
        }
      }

      function relativeNow(player) {
        return Date.now() / 1000 - player.zeroTime;
      }

      function seekRelative(player, delta) {
        player.seekTo(relativeNow(player) + delta, true);
      }

      function getRelative(player) {
        return player.getCurrentTime() - relativeNow(player);
      }

      function secondsToHHMMSS(seconds) {
        return new Date(seconds * 1000).toISOString().slice(11, 19);
      }

      function stopAll() {
        players.forEach(player => player.stopVideo());
      }
      function pauseAll() {
        players.forEach(player => player.pauseVideo());
      }
      function playAll() {
        players.forEach(player => player.playVideo());
        timeSelect.value = getRelative(players[0]);
        timeLabel.innerHTML = '-' + secondsToHHMMSS(-timeSelect.value);
      }
      function seekAll(delta) {
        players.forEach(player => seekRelative(player, delta));
      }
      function syncAll() {
        let offset = Number(timeSelect.value);
        let times = players.map(p => p.getMediaReferenceTime());
        let earliest = Math.min(...times);
        let deltas = times.map(t => earliest - t);
        deltas.forEach((delta, i) => seekRelative(players[i], delta + offset));
      }
    </script>
  </head>
  <body>
    <div id="players">
    </div>
    <hr />
    <input type="button" onclick="stopAll()" value="Stop" />
    <input type="button" onclick="pauseAll()" value="Pause" />
    <input type="button" onclick="playAll()" value="Play" />
    <input type="button" onclick="syncAll()" value="Sync" />
    <br />
    <input type="range" id="time" name="time" min="-43200" max="0" step="any" list="hours" value="0" />
    <label id="timeLabel" for="time">-00:00:00</label>
    <datalist id="hours">
        <option value="-43200" label="-12" />
        <option value="-39600" />
        <option value="-36000" label="-10" />
        <option value="-32400" />
        <option value="-28800" label="-8" />
        <option value="-25200" />
        <option value="-21600" label="-6" />
        <option value="-18000" />
        <option value="-14400" label="-4" />
        <option value="-10800" />
        <option value="-7200" label="-2" />
        <option value="-3600" />
        <option value="0" label="now" />
    </datalist>

    <script type="text/javascript">
        const timeSelect = document.querySelector('#time');
        const timeLabel = document.querySelector('#timeLabel');
        const playersDiv = document.querySelector('#players');
    </script>
  </body>
</html>
